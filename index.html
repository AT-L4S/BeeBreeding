<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Interactive Bee Breeding Tree</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #eeeeee;
        }

        .chart-container {
            width: 100vw;
            height: 100vh;
            overflow: auto;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node rect {
            stroke: #fff;
            stroke-width: 2px;
            rx: 20px;
            ry: 15px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
        }

        .node.highlighted rect {
            stroke: #ff4444 !important;
            stroke-width: 4px !important;
            filter: drop-shadow(0 0 10px rgba(255, 68, 68, 0.5));
        }

        .node.connected rect {
            stroke: #44ff44 !important;
            stroke-width: 3px !important;
            filter: drop-shadow(0 0 8px rgba(68, 255, 68, 0.5));
        }

        .node.faded {
            opacity: 0.2;
            transition: opacity 0.3s ease;
        }

        .node.highlighted,
        .node.connected {
            z-index: 1000;
        }

        .node text {
            font: 14px Arial;
            text-anchor: middle;
            fill: white;
            stroke: black;
            stroke-width: 3px;
            paint-order: stroke fill;
            pointer-events: none;
            font-weight: bold;
            text-transform: uppercase;
        }

        .link {
            fill: none;
            stroke-opacity: 0.8;
            stroke-width: 2px;
        }

        .link.highlighted {
            stroke-opacity: 1 !important;
            stroke-width: 4px !important;
        }

        .link.faded {
            opacity: 0.1;
            transition: opacity 0.3s ease;
        }

        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .search-box {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        .btn {
            padding: 6px 12px;
            margin: 2px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background: #0056b3;
        }

        .info-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 250px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" class="search-box" placeholder="Search bee species..." id="searchInput">
        <br>
        <button class="btn" onclick="resetHighlight()">Clear Selection</button>
        <button class="btn" onclick="fitView()">Fit to View</button>
    </div>

    <div class="info-panel" id="infoPanel">
        <h4 id="selectedBee">Selected Bee</h4>
        <div><strong>Generation:</strong> <span id="generation"></span></div>
        <div><strong>Parents:</strong>
            <div id="parents"></div>
        </div>
        <div><strong>Children:</strong>
            <div id="children"></div>
        </div>
    </div>

    <div class="chart-container">
        <svg id="tree-svg"></svg>
    </div>

    <script>
        // Parse bee mutation data from the bees.txt content
        const rawMutations = {
            "Abandoned": {
                parents: ["Oblivion", "Nameless"],
                mod: "MagicBees"
            },
            "Abnormal": {
                parents: ["Ender", "Secluded"],
                mod: "ExtraBees"
            },
            "Absolute": {
                parents: ["Ocean", "Frigid"],
                mod: "ExtraBees"
            },
            "Abyssal": {
                parents: ["Shadowed", "Darkened"],
                mod: "ExtraBees"
            },
            "Acidic": {
                parents: ["Corrosive", "Caustic"],
                mod: "ExtraBees"
            },
            "Aedial": {
                parents: ["Skeletal", "Scholarly"],
                mod: "MeatballCraft"
            },
            "Agrarian": {
                parents: ["Farmerly", "Industrious"],
                mod: "Forestry"
            },
            "Agricultural": {
                parents: ["Virulent", "Doctoral"],
                mod: "MeatballCraft"
            },
            "Aluminum": {
                parents: ["Cultivated", "Industrious"],
                mod: "MagicBees"
            },
            "Amber": {
                parents: ["Maroon", "Saffron"],
                mod: "ExtraBees"
            },
            "Amped": {
                parents: ["Shocking", "Windy"],
                mod: "MagicBees"
            },
            "Ancient": {
                parents: ["Noble", "Diligent"],
                mod: "ExtraBees"
            },
            "Apatine": {
                parents: ["Rural", "Cuprum"],
                mod: "MagicBees"
            },
            "Arcane": {
                parents: ["Esoteric", "Mysterious"],
                mod: "MagicBees"
            },
            "Argentum": {
                parents: ["Modest", "Imperial"],
                mod: "MagicBees"
            },
            "Arid": {
                parents: ["Meadows", "Frugal"],
                mod: "ExtraBees"
            },
            "Artistic": {
                parents: ["Cultivated", "Graduate"],
                mod: "Career Bees"
            },
            "Ashen": {
                parents: ["Bleached", "Slate"],
                mod: "ExtraBees"
            },
            "Assassin": {
                parents: ["Police", "Devil"],
                mod: "Career Bees"
            },
            "Auric": {
                parents: ["Plumbum", "Imperial"],
                mod: "MagicBees"
            },
            "Austere": {
                parents: ["Modest", "Frugal"],
                mod: "Forestry"
            },
            "Avenging": {
                parents: ["Vengeful", "Vindictive"],
                mod: "Forestry"
            },
            "Aware": {
                parents: ["Attuned", "Ethereal"],
                mod: "MagicBees"
            },
            "Azure": {
                parents: ["Prussian", "Bleached"],
                mod: "ExtraBees"
            },
            "Baguette": {
                parents: ["Thief", "Pupil"],
                mod: "MeatballCraft"
            },
            "Balanced": {
                parents: ["Temporal", "Forlorn"],
                mod: "MeatballCraft"
            },
            "Barren": {
                parents: ["Common", "Arid"],
                mod: "ExtraBees"
            },
            "Batty": {
                parents: ["Shulking", "Windy"],
                mod: "MagicBees"
            },
            "Bauxite": {
                parents: ["Resilient", "Diligent"],
                mod: "ExtraBees"
            },
            "Beefy": {
                parents: ["Common", "Shulking"],
                mod: "MagicBees"
            },
            "Big Bad": {
                parents: ["Shulking", "Mysterious"],
                mod: "MagicBees"
            },
            "Black": {
                parents: ["White", "Diligent"],
                mod: "Forestry"
            },
            "Bleached": {
                parents: ["Wintry", "Valiant"],
                mod: "ExtraBees"
            },
            "Blizzy": {
                parents: ["Wintry", "Shulking"],
                mod: "ExtraBees"
            },
            "Blooming": {
                parents: ["Industrious", "Thriving"],
                mod: "ExtraBees"
            },
            "Blossom": {
                parents: ["Botanic", "Earthen"],
                mod: "MagicBees"
            },
            "Blue": {
                parents: ["Forest", "Diligent"],
                mod: "Forestry"
            },
            "Blutonium": {
                parents: ["Cyanite", "Yellorium"],
                mod: "ExtraBees"
            },
            "Boggy": {
                parents: ["Miry", "Swamp"],
                mod: "ExtraBees"
            },
            "Bovine": {
                parents: ["Water", "Farmerly"],
                mod: "ExtraBees"
            },
            "Bronzed": {
                parents: ["Stannum", "Cuprum"],
                mod: "MagicBees"
            },
            "Brown": {
                parents: ["Tropical", "Diligent"],
                mod: "Forestry"
            },
            "Buisness": {
                parents: ["Imperial", "PHD"],
                mod: "Career Bees"
            },
            "Buried": {
                parents: ["Skystone", "Valuable"],
                mod: "MeatballCraft"
            },
            "Butcher": {
                parents: ["Lumber", "Graduate"],
                mod: "Career Bees"
            },
            "Carbon": {
                parents: ["Spiteful", "Stannum"],
                mod: "MagicBees"
            },
            "Catty": {
                parents: ["Poultry", "Spidery"],
                mod: "MagicBees"
            },
            "Caustic": {
                parents: ["Fiendish", "Corrosive"],
                mod: "ExtraBees"
            },
            "Celebratory": {
                parents: ["Austere", "Excited"],
                mod: "ExtraBees"
            },
            "ChaosStrikez": {
                parents: ["Energetic", "Savant"],
                mod: "MeatballCraft"
            },
            "Charmed": {
                parents: ["Cultivated", "Eldritch"],
                mod: "MagicBees"
            },
            "Chevron": {
                parents: ["Light Blue", "Robot"],
                mod: "MeatballCraft"
            },
            "Cinnabar": {
                parents: ["Sinister", "Resilient"],
                mod: "ExtraBees"
            },
            "Classical": {
                parents: ["Greek", "Roman"],
                mod: "ExtraBees"
            },
            "Clockwork": {
                parents: ["Smelter", "Engineer"],
                mod: "Career Bees"
            },
            "Cobalt": {
                parents: ["Infernal", "Imperial"],
                mod: "MagicBees"
            },
            "Collecting": {
                parents: ["Student", "Common"],
                mod: "Career Bees"
            },
            "Common": {
                parents: ["Meadows", "Forest"],
                mod: "Forestry"
            },
            "Connor": {
                parents: ["Radioactive", "Draconic"],
                mod: "MeatballCraft"
            },
            "Controller": {
                parents: ["Ringbearer", "Chevron"],
                mod: "MeatballCraft"
            },
            "Corroded": {
                parents: ["Wintry", "Resilient"],
                mod: "ExtraBees"
            },
            "Corrosive": {
                parents: ["Malicious", "Viscous"],
                mod: "ExtraBees"
            },
            "Creepy": {
                parents: ["Modest", "Desolate"],
                mod: "ExtraBees"
            },
            "Crumbling": {
                parents: ["Unusual", "Mutable"],
                mod: "MagicBees"
            },
            "Cultivated": {
                parents: ["Meadows", "Common"],
                mod: "Forestry"
            },
            "Cuprum": {
                parents: ["Meadows", "Industrious"],
                mod: "MagicBees"
            },
            "Cyan": {
                parents: ["Green", "Blue"],
                mod: "Forestry"
            },
            "Cyanite": {
                parents: ["Nuclear", "Yellorium"],
                mod: "ExtraBees"
            },
            "Damp": {
                parents: ["Water", "Miry"],
                mod: "ExtraBees"
            },
            "Dante": {
                parents: ["Austere", "Smouldering"],
                mod: "MagicBees"
            },
            "Darkened": {
                parents: ["Shadowed", "Rocky"],
                mod: "ExtraBees"
            },
            "Decaying": {
                parents: ["Meadows", "Desolate"],
                mod: "ExtraBees"
            },
            "Decomposing": {
                parents: ["Marshy", "Barren"],
                mod: "ExtraBees"
            },
            "Demonic": {
                parents: ["Sinister", "Fiendish"],
                mod: "Forestry"
            },
            "Dentist": {
                parents: ["High-Pitched", "Hyperventilating"],
                mod: "MeatballCraft"
            },
            "Derpious": {
                parents: ["Marshy", "Cultivated"],
                mod: "Forestry"
            },
            "Desolate": {
                parents: ["Arid", "Barren"],
                mod: "ExtraBees"
            },
            "Destabilized": {
                parents: ["Industrious", "Spiteful"],
                mod: "MagicBees"
            },
            "Devil": {
                parents: ["Smelter", "Demonic"],
                mod: "Career Bees"
            },
            "Diamandi": {
                parents: ["Austere", "Auric"],
                mod: "MagicBees"
            },
            "Diamond": {
                parents: ["Cultivated", "Lapis"],
                mod: "ExtraBees"
            },
            "Diligent": {
                parents: ["Common", "Cultivated"],
                mod: "Forestry"
            },
            "Distilled": {
                parents: ["Industrious", "Oily"],
                mod: "ExtraBees"
            },
            "Doctor": {
                parents: ["PHD", "Majestic"],
                mod: "Career Bees"
            },
            "Doctoral": {
                parents: ["Timely", "Lordly"],
                mod: "MagicBees"
            },
            "Draconic": {
                parents: ["Abandoned", "Imperial"],
                mod: "MagicBees"
            },
            "Dreaming": {
                parents: ["Windy", "Somnolent"],
                mod: "MagicBees"
            },
            "Earthen": {
                parents: ["Supernatural", "Ethereal"],
                mod: "MagicBees"
            },
            "Ebony": {
                parents: ["Rocky", "Valiant"],
                mod: "ExtraBees"
            },
            "Ecstatic": {
                parents: ["Excited", "Energetic"],
                mod: "ExtraBees"
            },
            "Edenic": {
                parents: ["Tropical", "Exotic"],
                mod: "Forestry"
            },
            "Eldritch": {
                parents: ["Mystical", "Cultivated"],
                mod: "MagicBees"
            },
            "Electrician": {
                parents: ["Clockwork", "Engineer"],
                mod: "Career Bees"
            },
            "Electrum": {
                parents: ["Argentum", "Auric"],
                mod: "MagicBees"
            },
            "EMBee": {
                parents: ["Ethereal", "Arcane"],
                mod: "MeatballCraft"
            },
            "Emerald": {
                parents: ["Forest", "Lapis"],
                mod: "ExtraBees"
            },
            "Enchanted": {
                parents: ["Eldritch", "Charmed"],
                mod: "MagicBees"
            },
            "Endearing": {
                parents: ["Winsome", "Carbon"],
                mod: "MagicBees"
            },
            "Energetic": {
                parents: ["Diligent", "Excited"],
                mod: "ExtraBees"
            },
            "Engineer": {
                parents: ["Noble", "PHD"],
                mod: "Career Bees"
            },
            "Esmeraldi": {
                parents: ["Austere", "Argentum"],
                mod: "ExtraBees"
            },
            "Esoteric": {
                parents: ["Cultivated", "Eldritch"],
                mod: "MagicBees"
            },
            "Ethereal": {
                parents: ["Supernatural", "Arcane"],
                mod: "MagicBees"
            },
            "Excited": {
                parents: ["Valiant", "Cultivated"],
                mod: "ExtraBees"
            },
            "Exotic": {
                parents: ["Austere", "Tropical"],
                mod: "Forestry"
            },
            "Experienced": {
                parents: ["Radiant", "Armored"],
                mod: "MeatballCraft"
            },
            "Farmed": {
                parents: ["Meadows", "Farmerly"],
                mod: "ExtraBees"
            },
            "Farmerly": {
                parents: ["Rural", "Unweary"],
                mod: "Forestry"
            },
            "Fermented": {
                parents: ["Farmerly", "Meadows"],
                mod: "ExtraBees"
            },
            "Ferrous": {
                parents: ["Common", "Industrious"],
                mod: "MagicBees"
            },
            "Fiendish": {
                parents: ["Sinister", "Cultivated"],
                mod: "Forestry"
            },
            "Fios": {
                parents: ["Light Blue", "Classical"],
                mod: "MeatballCraft"
            },
            "Firey": {
                parents: ["Supernatural", "Ethereal"],
                mod: "MagicBees"
            },
            "Floral": {
                parents: ["Botanic", "Blossom"],
                mod: "MagicBees"
            },
            "Fluxed": {
                parents: ["Electrum", "Destabilized"],
                mod: "MagicBees"
            },
            "Forlorn": {
                parents: ["Abandoned", "Nameless"],
                mod: "MagicBees"
            },
            "Formic": {
                parents: ["Meadows", "Acidic"],
                mod: "MeatballCraft"
            },
            "Fossilised": {
                parents: ["Growing", "Primeval"],
                mod: "ExtraBees"
            },
            "Freeky": {
                parents: ["Sweetened", "EMBee"],
                mod: "MeatballCraft"
            },
            "Frigid": {
                parents: ["Wintry", "Diligent"],
                mod: "ExtraBees"
            },
            "Frugal": {
                parents: ["Modest", "Sinister"],
                mod: "Forestry"
            },
            "Fruity": {
                parents: ["Sweetened", "Thriving"],
                mod: "ExtraBees"
            },
            "Fuchsia": {
                parents: ["Indigo", "Lavender"],
                mod: "ExtraBees"
            },
            "Fungal": {
                parents: ["Boggy", "Miry"],
                mod: "ExtraBees"
            },
            "Furious": {
                parents: ["Embittered", "Fiendish"],
                mod: "ExtraBees"
            },
            "Galvanized": {
                parents: ["Wintry", "Resilient"],
                mod: "ExtraBees"
            },
            "Gelid": {
                parents: ["Blizzy", "Icy"],
                mod: "ExtraBees"
            },
            "Glacial": {
                parents: ["Wintry", "Icy"],
                mod: "Forestry"
            },
            "Glittering": {
                parents: ["Majestic", "Rusty"],
                mod: "ExtraBees"
            },
            "Glowering": {
                parents: ["Furious", "Excited"],
                mod: "ExtraBees"
            },
            "Glutinous": {
                parents: ["Exotic", "Viscous"],
                mod: "ExtraBees"
            },
            "Graduate": {
                parents: ["Common", "Student"],
                mod: "Career Bees"
            },
            "Gray": {
                parents: ["Black", "White"],
                mod: "Forestry"
            },
            "Greek": {
                parents: ["Roman", "Marble"],
                mod: "ExtraBees"
            },
            "Green": {
                parents: ["Blue", "Yellow"],
                mod: "Forestry"
            },
            "Grounded": {
                parents: ["Smouldering", "Earthen"],
                mod: "MagicBees"
            },
            "Growing": {
                parents: ["Forest", "Diligent"],
                mod: "ExtraBees"
            },
            "Hateful": {
                parents: ["Infernal", "Eldritch"],
                mod: "MagicBees"
            },
            "Hazardous": {
                parents: ["Austere", "Desolate"],
                mod: "ExtraBees"
            },
            "Heraldry": {
                parents: ["Spectral", "Endearing"],
                mod: "MeatballCraft"
            },
            "Herblore": {
                parents: ["Esoteric", "Quantum"],
                mod: "MeatballCraft"
            },
            "Hermitic": {
                parents: ["Secluded", "Monastic"],
                mod: "Forestry"
            },
            "Heroic": {
                parents: ["Valiant", "Steadfast"],
                mod: "Forestry"
            },
            "High-Pitched": {
                parents: ["Oxygen", "Deep Learner"],
                mod: "MeatballCraft"
            },
            "Honey-Smelter": {
                parents: ["Graduate", "Smelter"],
                mod: "Career Bees"
            },
            "Husbandry": {
                parents: ["Meadows", "Graduate"],
                mod: "Career Bees"
            },
            "Hyperventilating": {
                parents: ["Imperial", "Student"],
                mod: "MeatballCraft"
            },
            "Icy": {
                parents: ["Wintry", "Industrious"],
                mod: "Forestry"
            },
            "Imperial": {
                parents: ["Noble", "Majestic"],
                mod: "Forestry"
            },
            "Impregnable": {
                parents: ["Cultivated", "Resilient"],
                mod: "ExtraBees"
            },
            "Indigo": {
                parents: ["Maroon", "Prussian"],
                mod: "ExtraBees"
            },
            "Industrious": {
                parents: ["Diligent", "Unweary"],
                mod: "Forestry"
            },
            "Infectious": {
                parents: ["Tropical", "Malicious"],
                mod: "ExtraBees"
            },
            "Invar": {
                parents: ["Ferrous", "Nickel"],
                mod: "MagicBees"
            },
            "Invincible": {
                parents: ["Common", "Resilient"],
                mod: "ExtraBees"
            },
            "Invisible": {
                parents: ["Mystical", "Mutable"],
                mod: "MagicBees"
            },
            "Isekai": {
                parents: ["Crepuscular", "Deep Learner"],
                mod: "MeatballCraft"
            },
            "Jaded": {
                parents: ["Ender", "Relic"],
                mod: "ExtraBees"
            },
            "Junk Seller": {
                parents: ["Common", "Buisness"],
                mod: "Career Bees"
            },
            "KurryCat": {
                parents: ["Scholarly", "PHD"],
                mod: "MeatballCraft"
            },
            "Lapis": {
                parents: ["Water", "Resilient"],
                mod: "ExtraBees"
            },
            "Lavender": {
                parents: ["Maroon", "Bleached"],
                mod: "ExtraBees"
            },
            "Leaden": {
                parents: ["Meadows", "Resilient"],
                mod: "ExtraBees"
            },
            "Light Blue": {
                parents: ["Blue", "White"],
                mod: "ExtraBees"
            },
            "Light Gray": {
                parents: ["Gray", "White"],
                mod: "Forestry"
            },
            "Lime": {
                parents: ["Natural", "Bleached"],
                mod: "ExtraBees"
            },
            "Lordly": {
                parents: ["Imperial", "Timely"],
                mod: "MagicBees"
            },
            "LordRaine": {
                parents: ["Sorcerous", "Temporal"],
                mod: "MeatballCraft"
            },
            "Luctor": {
                parents: ["Rainbow", "Abyssal"],
                mod: "MeatballCraft"
            },
            "Lumber": {
                parents: ["Forest", "Graduate"],
                mod: "Career Bees"
            },
            "Lustered": {
                parents: ["Forest", "Resilient"],
                mod: "ExtraBees"
            },
            "Lux": {
                parents: ["Infernal", "Smouldering"],
                mod: "MagicBees"
            },
            "Mad Scientist": {
                parents: ["Science", "Engineer"],
                mod: "Career Bees"
            },
            "Magenta": {
                parents: ["Blue", "Pink"],
                mod: "ExtraBees"
            },
            "Majestic": {
                parents: ["Noble", "Cultivated"],
                mod: "Forestry"
            },
            "Malicious": {
                parents: ["Tropical", "Sinister"],
                mod: "ExtraBees"
            },
            "Manyullyn": {
                parents: ["Ardite", "Cobalt"],
                mod: "MagicBees"
            },
            "Maroon": {
                parents: ["Forest", "Valiant"],
                mod: "MagicBees"
            },
            "Mason": {
                parents: ["Smelter", "Graduate"],
                mod: "Career Bees"
            },
            "Mathias": {
                parents: ["Ringbearer", "Robust"],
                mod: "MeatballCraft"
            },
            "Meatball": {
                parents: ["Industrious", "Common"],
                mod: "MeatballCraft"
            },
            "Miry": {
                parents: ["Marshy", "Noble"],
                mod: "Forestry"
            },
            "Mutable": {
                parents: ["Unusual", "Eldritch"],
                mod: "MagicBees"
            },
            "Mysterious": {
                parents: ["Forest", "Common"],
                mod: "MagicBees"
            },
            "Mystical": {
                parents: ["Noble", "Monastic"],
                mod: "MagicBees"
            },
            "N.C.A.": {
                parents: ["Devil", "Politician"],
                mod: "Career Bees"
            },
            "Nameless": {
                parents: ["Oblivion", "Ethereal"],
                mod: "MagicBees"
            },
            "Natural": {
                parents: ["Tropical", "Valiant"],
                mod: "ExtraBees"
            },
            "Necronomibee": {
                parents: ["Savant", "Abyssal"],
                mod: "MeatballCraft"
            },
            "Neighsayer": {
                parents: ["Beefy", "Sheepish"],
                mod: "MagicBees"
            },
            "NerdySpider": {
                parents: ["Phantasmal", "Esmeraldi"],
                mod: "MeatballCraft"
            },
            "Nickel": {
                parents: ["Ferrous", "Esoteric"],
                mod: "MagicBees"
            },
            "Noble": {
                parents: ["Cultivated", "Common"],
                mod: "Forestry"
            },
            "Nuclear Technician": {
                parents: ["Bomber", "PHD"],
                mod: "MeatballCraft"
            },
            "Nuclear": {
                parents: ["Unstable", "Rusty"],
                mod: "ExtraBees"
            },
            "Ocean": {
                parents: ["Water", "Diligent"],
                mod: "ExtraBees"
            },
            "Oily": {
                parents: ["Ocean", "Primeval"],
                mod: "ExtraBees"
            },
            "Orange": {
                parents: ["Yellow", "Red"],
                mod: "Forestry"
            },
            "Osmium": {
                parents: ["Argentum", "Cobalt"],
                mod: "MagicBees"
            },
            "Phantasmal": {
                parents: ["Ender", "Spectral"],
                mod: "Forestry"
            },
            "PHD": {
                parents: ["Graduate", "Student"],
                mod: "Career Bees"
            },
            "Pink": {
                parents: ["White", "Red"],
                mod: "Forestry"
            },
            "Plague": {
                parents: ["Sinister", "Doctor"],
                mod: "Career Bees"
            },
            "Platinum": {
                parents: ["Nickel", "Invar"],
                mod: "MagicBees"
            },
            "Plumbum": {
                parents: ["Common", "Stannum"],
                mod: "MagicBees"
            },
            "Police": {
                parents: ["Valiant", "Graduate"],
                mod: "Career Bees"
            },
            "Politician": {
                parents: ["Devil", "Thief"],
                mod: "Career Bees"
            },
            "Porcine": {
                parents: ["Common", "Shulking"],
                mod: "MagicBees"
            },
            "Poultry": {
                parents: ["Common", "Shulking"],
                mod: "MagicBees"
            },
            "Prehistoric": {
                parents: ["Primeval", "Ancient"],
                mod: "ExtraBees"
            },
            "Priest": {
                parents: ["Graduate", "Yente"],
                mod: "Career Bees"
            },
            "Primeval": {
                parents: ["Secluded", "Ancient"],
                mod: "ExtraBees"
            },
            "Prussian": {
                parents: ["Water", "Valiant"],
                mod: "ExtraBees"
            },
            "Pupil": {
                parents: ["Arcane", "Monastic"],
                mod: "MagicBees"
            },
            "Purple": {
                parents: ["Red", "Blue"],
                mod: "Forestry"
            },
            "Pyramid": {
                parents: ["Lordly", "Temporal"],
                mod: "MeatballCraft"
            },
            "Pyrite": {
                parents: ["Rusty", "Sinister"],
                mod: "ExtraBees"
            },
            "Pyro": {
                parents: ["Dante", "Carbon"],
                mod: "MagicBees"
            },
            "Pyromaniacal": {
                parents: ["Devil", "Rainbow"],
                mod: "MeatballCraft"
            },
            "Quantum Charming": {
                parents: ["Phantasmal", "Mad Scientist"],
                mod: "Career Bees"
            },
            "Quantum Strange": {
                parents: ["Mad Scientist", "Phantasmal"],
                mod: "Career Bees"
            },
            "Quantum": {
                parents: ["Spectral", "Spatial"],
                mod: "ExtraBees"
            },
            "Radioactive": {
                parents: ["Nuclear", "Glittering"],
                mod: "ExtraBees"
            },
            "Rainbow": {
                parents: ["Artistic", "PHD"],
                mod: "Career Bees"
            },
            "Red": {
                parents: ["Common", "Diligent"],
                mod: "Forestry"
            },
            "Relic": {
                parents: ["Imperial", "Prehistoric"],
                mod: "ExtraBees"
            },
            "Resilient": {
                parents: ["Industrious", "Robust"],
                mod: "ExtraBees"
            },
            "RestlessClam": {
                parents: ["White", "Shocking"],
                mod: "MeatballCraft"
            },
            "Ringbearer": {
                parents: ["Glittering", "Endearing"],
                mod: "MeatballCraft"
            },
            "Ripening": {
                parents: ["Sweetened", "Growing"],
                mod: "ExtraBees"
            },
            "River": {
                parents: ["Water", "Diligent"],
                mod: "ExtraBees"
            },
            "Robot": {
                parents: ["Clockwork", "Electrician"],
                mod: "Career Bees"
            },
            "Robust": {
                parents: ["Tolerant", "Unweary"],
                mod: "ExtraBees"
            },
            "Rockin'": {
                parents: ["Grounded", "Earthen"],
                mod: "MagicBees"
            },
            "Roman": {
                parents: ["Marble", "Heroic"],
                mod: "ExtraBees"
            },
            "Rooted": {
                parents: ["Forest", "Eldritch"],
                mod: "MagicBees"
            },
            "Ruby": {
                parents: ["Modest", "Lapis"],
                mod: "ExtraBees"
            },
            "Rural": {
                parents: ["Meadows", "Diligent"],
                mod: "Forestry"
            },
            "Rusty": {
                parents: ["Meadows", "Resilient"],
                mod: "ExtraBees"
            },
            "Saffron": {
                parents: ["Meadows", "Valiant"],
                mod: "ExtraBees"
            },
            "Sandman366": {
                parents: ["Black", "Firey"],
                mod: "MeatballCraft"
            },
            "Sapphire": {
                parents: ["Water", "Lapis"],
                mod: "ExtraBees"
            },
            "Savant": {
                parents: ["Scholarly", "Pupil"],
                mod: "MagicBees"
            },
            "Scholarly": {
                parents: ["Pupil", "Arcane"],
                mod: "MagicBees"
            },
            "Science": {
                parents: ["PHD", "Industrious"],
                mod: "Career Bees"
            },
            "Secluded": {
                parents: ["Austere", "Monastic"],
                mod: "Forestry"
            },
            "Sepia": {
                parents: ["Marshy", "Valiant"],
                mod: "ExtraBees"
            },
            "Serenading": {
                parents: ["Arcane", "Radiant"],
                mod: "MeatballCraft"
            },
            "Shadow46x2": {
                parents: ["Fermented", "Transmuting"],
                mod: "MeatballCraft"
            },
            "Shadowed": {
                parents: ["Rocky", "Sinister"],
                mod: "ExtraBees"
            },
            "Sheepish": {
                parents: ["Porcine", "Shulking"],
                mod: "MagicBees"
            },
            "Shining": {
                parents: ["Majestic", "Galvanized"],
                mod: "ExtraBees"
            },
            "Shocking": {
                parents: ["Smouldering", "Windy"],
                mod: "MagicBees"
            },
            "Sinister": {
                parents: ["Modest", "Cultivated"],
                mod: "Forestry"
            },
            "Skeletal": {
                parents: ["Forest", "Desolate"],
                mod: "ExtraBees"
            },
            "Skystone": {
                parents: ["Earthen", "Windy"],
                mod: "MagicBees"
            },
            "Slate": {
                parents: ["Ebony", "Bleached"],
                mod: "ExtraBees"
            },
            "Smelter": {
                parents: ["Graduate", "Industrious"],
                mod: "Career Bees"
            },
            "Sodalite": {
                parents: ["Lapis", "Diligent"],
                mod: "ExtraBees"
            },
            "Sodden": {
                parents: ["Boggy", "Damp"],
                mod: "ExtraBees"
            },
            "Somnolent": {
                parents: ["Rooted", "Watery"],
                mod: "MagicBees"
            },
            "Soul": {
                parents: ["Spirit", "Aware"],
                mod: "MagicBees"
            },
            "Spatial": {
                parents: ["Abnormal", "Hermitic"],
                mod: "ExtraBees"
            },
            "Spectral": {
                parents: ["Ender", "Hermitic"],
                mod: "Forestry"
            },
            "Sphalerite": {
                parents: ["Tarnished", "Sinister"],
                mod: "ExtraBees"
            },
            "Spirit": {
                parents: ["Aware", "Ethereal"],
                mod: "MagicBees"
            },
            "Spiteful": {
                parents: ["Infernal", "Hateful"],
                mod: "MagicBees"
            },
            "SpoonyPanda": {
                parents: ["Supernatural", "Resilient"],
                mod: "MeatballCraft"
            },
            "StaffiX": {
                parents: ["Water", "Prehistoric"],
                mod: "MeatballCraft"
            },
            "Stained": {
                parents: ["Ebony", "Ocean"],
                mod: "ExtraBees"
            },
            "Stannum": {
                parents: ["Forest", "Industrious"],
                mod: "MagicBees"
            },
            "Stargazer": {
                parents: ["Quantum", "Classical"],
                mod: "MeatballCraft"
            },
            "Sticky": {
                parents: ["Viscous", "Glutinous"],
                mod: "ExtraBees"
            },
            "Student": {
                parents: ["Common", "Cultivated"],
                mod: "Career Bees"
            },
            "Sugary": {
                parents: ["Rural", "Sweetened"],
                mod: "ExtraBees"
            },
            "Supernatural": {
                parents: ["Enchanted", "Charmed"],
                mod: "MagicBees"
            },
            "Sweetened": {
                parents: ["Valiant", "Diligent"],
                mod: "ExtraBees"
            },
            "Tarnished": {
                parents: ["Marshy", "Resilient"],
                mod: "MagicBees"
            },
            "Tarry": {
                parents: ["Distilled", "Fossilised"],
                mod: "ExtraBees"
            },
            "Temporal": {
                parents: ["Quantum Charming", "Quantum Strange"],
                mod: "Career Bees"
            },
            "Thermally Expanded": {
                parents: ["Pyro", "PHD"],
                mod: "MeatballCraft"
            },
            "Thief": {
                parents: ["Sinister", "Police"],
                mod: "Career Bees"
            },
            "Thriving": {
                parents: ["Unweary", "Growing"],
                mod: "ExtraBees"
            },
            "Timely": {
                parents: ["Imperial", "Ethereal"],
                mod: "MagicBees"
            },
            "Tinkerest": {
                parents: ["Blutonium", "PHD"],
                mod: "MeatballCraft"
            },
            "Tolerant": {
                parents: ["Rocky", "Diligent"],
                mod: "ExtraBees"
            },
            "Transmuting": {
                parents: ["Unusual", "Mutable"],
                mod: "MagicBees"
            },
            "Turquoise": {
                parents: ["Natural", "Prussian"],
                mod: "ExtraBees"
            },
            "Unstable": {
                parents: ["Prehistoric", "Resilient"],
                mod: "ExtraBees"
            },
            "Unweary": {
                parents: ["Diligent", "Cultivated"],
                mod: "Forestry"
            },
            "UselessForce": {
                parents: ["Red", "Fiendish"],
                mod: "MeatballCraft"
            },
            "Valuable": {
                parents: ["Glittering", "Shining"],
                mod: "ExtraBees"
            },
            "Vengeful": {
                parents: ["Demonic", "Vindictive"],
                mod: "Forestry"
            },
            "Vindictive": {
                parents: ["Demonic", "Monastic"],
                mod: "Forestry"
            },
            "Virulent": {
                parents: ["Malicious", "Infectious"],
                mod: "ExtraBees"
            },
            "Viscous": {
                parents: ["Water", "Exotic"],
                mod: "ExtraBees"
            },
            "Volcanic": {
                parents: ["Demonic", "Furious"],
                mod: "ExtraBees"
            },
            "Watery": {
                parents: ["Supernatural", "Ethereal"],
                mod: "MagicBees"
            },
            "White": {
                parents: ["Wintry", "Diligent"],
                mod: "Forestry"
            },
            "Windy": {
                parents: ["Supernatural", "Ethereal"],
                mod: "MagicBees"
            },
            "Winsome": {
                parents: ["Oblivion", "Platinum"],
                mod: "MagicBees"
            },
            "Withering": {
                parents: ["Demonic", "Spiteful"],
                mod: "MagicBees"
            },
            "Yellorium": {
                parents: ["Frugal", "Nuclear"],
                mod: "ExtraBees"
            },
            "Yellow": {
                parents: ["Modest", "Diligent"],
                mod: "Forestry"
            },
            "Yente": {
                parents: ["Student", "Husbandry"],
                mod: "Career Bees"
            }
        };

        // Build comprehensive bee data structure with multiple parent possibilities
        function buildBeeData() {
            const beeData = {};
            const allBees = new Set();

            // Collect all bee names (children and parents)
            Object.keys(rawMutations).forEach(bee => {
                allBees.add(bee);
                rawMutations[bee].parents.forEach(parent => allBees.add(parent));
            });

            // Initialize all bees
            allBees.forEach(bee => {
                beeData[bee] = {
                    parentCombinations: [], // Array of parent pairs that can create this bee
                    children: new Set(),
                    mod: 'Unknown'
                };
            });

            // Populate parent combinations and children
            Object.entries(rawMutations).forEach(([bee, data]) => {
                beeData[bee].parentCombinations.push(data.parents);
                beeData[bee].mod = data.mod;

                // Add this bee as child to each parent
                data.parents.forEach(parent => {
                    if (beeData[parent]) {
                        beeData[parent].children.add(bee);
                    }
                });
            });

            // Convert children sets to arrays
            Object.keys(beeData).forEach(bee => {
                beeData[bee].children = Array.from(beeData[bee].children);
            });

            return beeData;
        }

        const beeData = buildBeeData();

        // High-contrast distinct colors for intelligent assignment (original good contrast colors)
        const availableColors = [
            "#e6194b", "#3cb44b", "#4363d8", "#f58231", "#911eb4", "#42d4f4", "#f032e6", "#bfef45",
            "#fabed4", "#469990", "#dcbeff", "#9a6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1",
            "#000075", "#a9a9a9", "#000000"
        ];

        // Function to assign colors intelligently based on relationships and proximity
        function assignNodeColors(nodes, nodeMap) {
            const nodeColors = {};
            const conflicts = new Map(); // Map of node ID to set of conflicting node IDs

            // Initialize conflict sets
            nodes.forEach(node => {
                conflicts.set(node.id, new Set());
            });

            // Add parent-child conflicts
            nodes.forEach(node => {
                node.parents.forEach(parentId => {
                    if (conflicts.has(parentId)) {
                        conflicts.get(node.id).add(parentId);
                        conflicts.get(parentId).add(node.id);
                    }
                });
                node.children.forEach(childId => {
                    if (conflicts.has(childId)) {
                        conflicts.get(node.id).add(childId);
                        conflicts.get(childId).add(node.id);
                    }
                });
            });

            // Add spatial proximity conflicts (nodes close to each other)
            const proximityThreshold = 100; // pixels
            nodes.forEach(nodeA => {
                nodes.forEach(nodeB => {
                    if (nodeA.id !== nodeB.id) {
                        const distance = Math.sqrt(
                            Math.pow(nodeA.x - nodeB.x, 2) + Math.pow(nodeA.y - nodeB.y, 2)
                        );
                        if (distance < proximityThreshold) {
                            conflicts.get(nodeA.id).add(nodeB.id);
                            conflicts.get(nodeB.id).add(nodeA.id);
                        }
                    }
                });
            });

            // Welsh-Powell graph coloring algorithm
            // Sort nodes by degree (number of conflicts) in descending order
            const sortedNodes = nodes.slice().sort((a, b) =>
                conflicts.get(b.id).size - conflicts.get(a.id).size
            );

            // Assign colors with diversity preference
            sortedNodes.forEach((node, nodeIndex) => {
                const usedColors = new Set();

                // Find colors used by conflicting nodes
                conflicts.get(node.id).forEach(conflictId => {
                    if (nodeColors[conflictId] !== undefined) {
                        usedColors.add(nodeColors[conflictId]);
                    }
                });

                // Create a preferred color based on generation and position for diversity
                const preferredColor = (node.generation * 3 + Math.abs(node.y) / 50) % availableColors.length;

                // Try preferred color first if available
                if (!usedColors.has(Math.floor(preferredColor))) {
                    nodeColors[node.id] = Math.floor(preferredColor);
                } else {
                    // Find first available color, but with some randomization for diversity
                    let colorIndex = (nodeIndex * 7) % availableColors.length; // Start at different positions
                    let attempts = 0;

                    while (usedColors.has(colorIndex) && attempts < availableColors.length) {
                        colorIndex = (colorIndex + 1) % availableColors.length;
                        attempts++;
                    }

                    // If we run out of colors, use fallback with node-specific offset
                    if (attempts >= availableColors.length) {
                        colorIndex = Math.abs(node.id.split('').reduce((a, b) => {
                            a = ((a << 5) - a) + b.charCodeAt(0);
                            return a & a;
                        }, 0)) % availableColors.length;
                    }

                    nodeColors[node.id] = colorIndex;
                }
            });

            return nodeColors;
        }

        // Convert data to hierarchical structure with multiple parent support
        function buildHierarchy() {
            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // First pass: create all nodes and determine generations
            const allBees = Object.keys(beeData);
            const generationMap = new Map();
            const visitedBees = new Set();

            // Find base bees (those that have no parents defined in mutations)
            const baseBees = allBees.filter(bee =>
                beeData[bee].parentCombinations.length === 0
            );

            // Set base generation for base bees
            baseBees.forEach(bee => {
                generationMap.set(bee, 0);
                visitedBees.add(bee);
            });

            // Iteratively assign generations based on parent relationships
            let changed = true;
            while (changed) {
                changed = false;
                allBees.forEach(bee => {
                    if (!visitedBees.has(bee)) {
                        const parentCombinations = beeData[bee].parentCombinations;
                        if (parentCombinations.length > 0) {
                            // Find the maximum generation among all possible parent combinations
                            let maxParentGeneration = -1;
                            let allParentsHaveGeneration = true;

                            for (const parents of parentCombinations) {
                                let combinationMaxGen = -1;
                                let combinationValid = true;

                                for (const parent of parents) {
                                    if (!generationMap.has(parent)) {
                                        combinationValid = false;
                                        break;
                                    }
                                    combinationMaxGen = Math.max(combinationMaxGen, generationMap.get(parent));
                                }

                                if (combinationValid) {
                                    maxParentGeneration = Math.max(maxParentGeneration, combinationMaxGen);
                                } else {
                                    allParentsHaveGeneration = false;
                                }
                            }

                            if (maxParentGeneration >= 0 && allParentsHaveGeneration) {
                                generationMap.set(bee, maxParentGeneration + 1);
                                visitedBees.add(bee);
                                changed = true;
                            }
                        }
                    }
                });
            }

            // Create nodes with generation information
            allBees.forEach(bee => {
                const generation = generationMap.get(bee) || 0;
                const node = {
                    id: bee,
                    generation: generation,
                    children: beeData[bee].children || [],
                    parentCombinations: beeData[bee].parentCombinations || [],
                    parents: [], // Flattened list of all unique parents
                    mod: beeData[bee].mod || 'Unknown'
                };

                // Flatten all parent combinations for display purposes
                const allParents = new Set();
                node.parentCombinations.forEach(combination => {
                    combination.forEach(parent => allParents.add(parent));
                });
                node.parents = Array.from(allParents);

                nodes.push(node);
                nodeMap.set(bee, node);
            });

            // Calculate positions first
            const generationGroups = d3.group(nodes, d => d.generation);
            const xSpacing = 180;
            const ySpacing = 40;

            nodes.forEach(node => {
                const genNodes = generationGroups.get(node.generation);
                const genIndex = genNodes.indexOf(node);
                const genSize = genNodes.length;

                node.x = node.generation * xSpacing;
                node.y = (genIndex - (genSize - 1) / 2) * ySpacing + 400; // Using 400 as approximate middle
            });

            // Assign colors intelligently after positions are calculated
            const nodeColors = assignNodeColors(nodes, nodeMap);

            // Create links for all parent-child relationships
            nodes.forEach(childNode => {
                childNode.parentCombinations.forEach(parentPair => {
                    parentPair.forEach(parentId => {
                        if (nodeMap.has(parentId)) {
                            links.push({
                                source: parentId,
                                target: childNode.id,
                                type: 'breeding'
                            });
                        }
                    });
                });
            });

            return {
                nodes,
                links,
                nodeMap
            };
        }

        const hierarchyData = buildHierarchy();
        const {
            nodes,
            links,
            nodeMap
        } = hierarchyData;

        // Calculate positions first
        const generationGroups = d3.group(nodes, d => d.generation);
        const xSpacing = 180;
        const ySpacing = 40;

        nodes.forEach(node => {
            const genNodes = generationGroups.get(node.generation);
            const genIndex = genNodes.indexOf(node);
            const genSize = genNodes.length;

            node.x = node.generation * xSpacing;
            node.y = (genIndex - (genSize - 1) / 2) * ySpacing + 400;
        });

        // Assign colors intelligently after positions are calculated
        const nodeColors = assignNodeColors(nodes, nodeMap);

        // Set up SVG with equal margins
        const margin = {
            top: 100,
            right: 100,
            bottom: 100,
            left: 100
        };
        const width = 1200; // Fixed reasonable width
        const height = 800; // Fixed reasonable height

        const svg = d3.select("#tree-svg")
            .attr("width", "100%")
            .attr("height", "100vh")
            .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Create separate groups for proper layering
        const linkGroup = g.append("g").attr("class", "links");
        const nodeGroup = g.append("g").attr("class", "nodes");

        // No arrow markers needed anymore
        const defs = svg.append("defs");

        // Add zoom behavior with proper mouse-relative zooming and symmetric pan constraints
        const zoom = d3.zoom()
            .scaleExtent([0.3, 2])
            .on("zoom", (event) => {
                const transform = event.transform;
                const svgWidth = svg.node().clientWidth || 1200;
                const svgHeight = svg.node().clientHeight || 800;

                // Calculate tree bounds
                const treeMinX = Math.min(...nodes.map(n => n.x - (n.width || 100) / 2));
                const treeMaxX = Math.max(...nodes.map(n => n.x + (n.width || 100) / 2));
                const treeMinY = Math.min(...nodes.map(n => n.y));
                const treeMaxY = Math.max(...nodes.map(n => n.y));

                const treeWidth = (treeMaxX - treeMinX) * transform.k;
                const treeHeight = (treeMaxY - treeMinY) * transform.k;

                // Symmetric padding - equal distance from edges
                const padding = 150;

                // Calculate symmetric bounds - only constrain if necessary
                const maxTranslateX = padding;
                const minTranslateX = svgWidth - treeWidth - padding;
                const maxTranslateY = padding;
                const minTranslateY = svgHeight - treeHeight - padding;

                // Only constrain if the tree would go outside bounds
                let constrainedX = transform.x;
                let constrainedY = transform.y;

                if (minTranslateX < maxTranslateX) {
                    constrainedX = Math.max(minTranslateX, Math.min(maxTranslateX, transform.x));
                }
                if (minTranslateY < maxTranslateY) {
                    constrainedY = Math.max(minTranslateY, Math.min(maxTranslateY, transform.y));
                }

                // Apply the transform - D3 handles mouse-relative zooming automatically
                g.attr("transform",
                    `translate(${constrainedX + margin.left}, ${constrainedY + margin.top}) scale(${transform.k})`
                );
            });

        svg.call(zoom);

        // Update positions with proper height calculation
        nodes.forEach(node => {
            const genNodes = generationGroups.get(node.generation);
            const genIndex = genNodes.indexOf(node);
            const genSize = genNodes.length;

            node.x = node.generation * xSpacing;
            node.y = (genIndex - (genSize - 1) / 2) * ySpacing + height / 2;
        });

        // Function to estimate text width (approximate) - updated for larger font and stroke
        function getTextWidth(text, fontSize = 14) {
            // Updated approximation: 14px font with 3px stroke ~= 8px per character for uppercase
            return Math.max(100, text.toUpperCase().length * 8 + 30); // 30px padding for thicker stroke
        }

        // Calculate and store width for each node BEFORE creating links
        nodes.forEach(node => {
            node.width = getTextWidth(node.id);
        });

        // Create links in the link group (will be below nodes)
        const link = linkGroup.selectAll(".link")
            .data(links)
            .join("path")
            .attr("class", "link")
            .attr("d", d => {
                const source = nodeMap.get(d.source);
                const target = nodeMap.get(d.target);
                const midX = (source.x + target.x) / 2;
                const sourceWidth = source.width || 120;
                const targetWidth = target.width || 120;
                return `M${source.x + sourceWidth/2},${source.y} Q${midX},${source.y} ${midX},${(source.y + target.y) / 2} Q${midX},${target.y} ${target.x - targetWidth/2},${target.y}`;
            })
            .style("stroke", d => {
                return availableColors[nodeColors[d.source] || 0];
            });

        // Create nodes in the node group (will be above links)
        const node = nodeGroup.selectAll(".node")
            .data(nodes)
            .join("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);

        // Add rectangles with intelligently assigned colors - dynamic width for each node
        node.append("rect")
            .attr("width", d => d.width)
            .attr("height", 30)
            .attr("x", d => -d.width / 2) // Center the rectangle
            .attr("y", -15)
            .style("fill", d => {
                return availableColors[nodeColors[d.id] || 0];
            });

        // Add text labels
        node.append("text")
            .attr("dy", "0.35em")
            .text(d => d.id);

        // Click handler for highlighting
        node.on("click", function(event, d) {
            event.stopPropagation();
            highlightConnections(d);
            showInfo(d);
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length > 2) {
                const foundNode = nodes.find(n => n.id.toLowerCase().includes(searchTerm));
                if (foundNode) {
                    highlightConnections(foundNode);
                    showInfo(foundNode);
                    // Gentle center on found node without aggressive panning
                    const currentTransform = d3.zoomTransform(svg.node());
                    const nodeScreenX = currentTransform.applyX(foundNode.x);
                    const nodeScreenY = currentTransform.applyY(foundNode.y);

                    // Only pan if node is significantly off-screen
                    if (nodeScreenX < 100 || nodeScreenX > width - 100 ||
                        nodeScreenY < 100 || nodeScreenY > height - 100) {
                        const transform = d3.zoomIdentity
                            .translate(width / 2 - foundNode.x, height / 2 - foundNode.y)
                            .scale(currentTransform.k);
                        svg.transition().duration(500).call(zoom.transform, transform);
                    }
                }
            } else {
                resetHighlight();
            }
        });

        function getAllAncestors(nodeId, visited = new Set()) {
            if (visited.has(nodeId)) return new Set(); // Prevent infinite loops
            visited.add(nodeId);

            const ancestors = new Set();
            const node = nodeMap.get(nodeId);
            if (node && node.parents) {
                node.parents.forEach(parentId => {
                    ancestors.add(parentId);
                    const parentAncestors = getAllAncestors(parentId, new Set(visited));
                    parentAncestors.forEach(ancestor => ancestors.add(ancestor));
                });
            }
            return ancestors;
        }

        function getAllDescendants(nodeId, visited = new Set()) {
            if (visited.has(nodeId)) return new Set(); // Prevent infinite loops
            visited.add(nodeId);

            const descendants = new Set();
            const node = nodeMap.get(nodeId);
            if (node && node.children) {
                node.children.forEach(childId => {
                    descendants.add(childId);
                    const childDescendants = getAllDescendants(childId, new Set(visited));
                    childDescendants.forEach(descendant => descendants.add(descendant));
                });
            }
            return descendants;
        }

        function highlightConnections(selectedNode) {
            // Reset highlighting and fading
            node.classed("highlighted connected faded", false);
            link.classed("highlighted faded", false);

            // Highlight selected node
            node.filter(d => d.id === selectedNode.id).classed("highlighted", true);

            // Recursively collect ALL ancestors and descendants
            const allAncestors = getAllAncestors(selectedNode.id);
            const allDescendants = getAllDescendants(selectedNode.id);

            // Collect connected node IDs (all recursive parents and children)
            const connectedIds = new Set([selectedNode.id]);
            allAncestors.forEach(id => connectedIds.add(id));
            allDescendants.forEach(id => connectedIds.add(id));

            // Highlight connected nodes (all ancestors and descendants)
            node.filter(d => allAncestors.has(d.id) || allDescendants.has(d.id))
                .classed("connected", true);

            // Fade out unconnected nodes
            node.filter(d => !connectedIds.has(d.id)).classed("faded", true);

            // Highlight relevant links - any link between connected nodes
            const highlightedLinks = link.filter(d =>
                connectedIds.has(d.source) && connectedIds.has(d.target)
            );

            highlightedLinks.classed("highlighted", true);

            // Fade non-highlighted links
            link.filter(d =>
                !(connectedIds.has(d.source) && connectedIds.has(d.target))
            ).classed("faded", true);

            // Move highlighted links to end of link group (above faded links but below all nodes)
            highlightedLinks.each(function() {
                linkGroup.node().appendChild(this);
            });

            // Ensure connected nodes stay in node group (above all links)
            node.filter(d => allAncestors.has(d.id) || allDescendants.has(d.id) || d.id === selectedNode.id)
                .each(function() {
                    nodeGroup.node().appendChild(this);
                });
        }

        function resetHighlight() {
            node.classed("highlighted connected faded", false);
            link.classed("highlighted faded", false);
            document.getElementById('infoPanel').style.display = 'none';
        }

        function showInfo(selectedNode) {
            document.getElementById('selectedBee').textContent = selectedNode.id;
            document.getElementById('generation').textContent = selectedNode.generation;

            // Display parent combinations
            const parentsDiv = document.getElementById('parents');
            if (selectedNode.parentCombinations && selectedNode.parentCombinations.length > 0) {
                const parentText = selectedNode.parentCombinations
                    .map(combo => combo.join(' + '))
                    .join(' OR ');
                parentsDiv.textContent = parentText;
            } else {
                parentsDiv.textContent = 'None (Base species)';
            }

            document.getElementById('children').textContent = selectedNode.children.join(', ') ||
                'None (Final evolution)';
            document.getElementById('infoPanel').style.display = 'block';
        }

        function fitView() {
            // Calculate proper bounds to fit all nodes
            const treeMinX = Math.min(...nodes.map(n => n.x - (n.width || 100) / 2));
            const treeMaxX = Math.max(...nodes.map(n => n.x + (n.width || 100) / 2));
            const treeMinY = Math.min(...nodes.map(n => n.y));
            const treeMaxY = Math.max(...nodes.map(n => n.y));

            const padding = 50;
            const treeWidth = treeMaxX - treeMinX + padding * 2;
            const treeHeight = treeMaxY - treeMinY + padding * 2;

            const svgWidth = 1200; // Use fixed width
            const svgHeight = 800; // Use fixed height

            // Calculate scale to fit both width and height with padding
            const scaleX = (svgWidth - padding * 2) / treeWidth;
            const scaleY = (svgHeight - padding * 2) / treeHeight;
            const scale = Math.min(scaleX, scaleY, 0.8); // Maximum scale of 0.8

            // Center the tree
            const centerX = (treeMinX + treeMaxX) / 2;
            const centerY = (treeMinY + treeMaxY) / 2;
            const translateX = svgWidth / 2 - centerX * scale;
            const translateY = svgHeight / 2 - centerY * scale;

            const transform = d3.zoomIdentity
                .translate(translateX, translateY)
                .scale(scale);

            svg.transition().duration(750).call(zoom.transform, transform);
        }

        // Clear selection on background click
        svg.on("click", resetHighlight);

        // Initial fit
        fitView();
    </script>
</body>
</html>
